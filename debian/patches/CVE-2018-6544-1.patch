X-Git-Url: http://git.ghostscript.com/?p=mupdf.git;a=blobdiff_plain;f=source%2Fpdf%2Fpdf-xref.c;h=ed09094cb3a7b99f474967b7dd481244732eac73;hp=723b543c0282c8ba3abd01c9bd430e1d0be714a4;hb=b03def134988da8c800adac1a38a41a1f09a1d89;hpb=26527eef77b3e51c2258c8e40845bfbc015e405d

Index: mupdf-1.9a+ds1/source/pdf/pdf-xref.c
===================================================================
--- mupdf-1.9a+ds1.orig/source/pdf/pdf-xref.c	2018-03-24 19:20:21.860771603 +0100
+++ mupdf-1.9a+ds1/source/pdf/pdf-xref.c	2018-03-24 19:20:21.836771603 +0100
@@ -1687,6 +1687,19 @@
 	{
 		objstm = pdf_load_object(ctx, doc, num, gen);
 
+		if (pdf_obj_marked(ctx, objstm))
+			fz_throw(ctx, FZ_ERROR_GENERIC, "recursive object stream lookup");
+	}
+	fz_catch(ctx)
+	{
+		pdf_drop_obj(ctx, objstm);
+		fz_rethrow(ctx);
+	}
+
+	fz_try(ctx)
+	{
+		pdf_mark_obj(ctx, objstm);
+
 		count = pdf_to_int(ctx, pdf_dict_get(ctx, objstm, PDF_NAME_N));
 		first = pdf_to_int(ctx, pdf_dict_get(ctx, objstm, PDF_NAME_First));
 
@@ -1766,6 +1779,7 @@
 		fz_drop_stream(ctx, stm);
 		fz_free(ctx, ofsbuf);
 		fz_free(ctx, numbuf);
+		pdf_unmark_obj(ctx, objstm);
 		pdf_drop_obj(ctx, objstm);
 	}
 	fz_catch(ctx)
