From 321ba1de287016b0036bf4a56ce774ad11763384 Mon Sep 17 00:00:00 2001
From: Sebastian Rasmussen <sebras@gmail.com>
Date: Tue, 19 Dec 2017 23:47:47 +0100
Subject: [PATCH] Bug 698825: Do not drop borrowed colorspaces.

Previously the borrowed colorspace was dropped when updating annotation
appearances, leading to use after free warnings from valgrind/ASAN.
---
 source/pdf/pdf-appearance.c | 8 ++------
 1 file changed, 2 insertions(+), 6 deletions(-)

Index: mupdf-1.9a+ds1/source/pdf/pdf-appearance.c
===================================================================
--- mupdf-1.9a+ds1.orig/source/pdf/pdf-appearance.c	2018-03-24 16:41:36.904757515 +0100
+++ mupdf-1.9a+ds1/source/pdf/pdf-appearance.c	2018-03-24 16:43:42.484757701 +0100
@@ -2163,7 +2163,6 @@
 	fz_device *dev = NULL;
 	font_info font_rec;
 	fz_text *text = NULL;
-	fz_colorspace *cs = NULL;
 
 	memset(&font_rec, 0, sizeof(font_rec));
 
@@ -2174,11 +2173,11 @@
 	fz_var(dlist);
 	fz_var(dev);
 	fz_var(text);
-	fz_var(cs);
 	fz_try(ctx)
 	{
 		char *contents = pdf_to_str_buf(ctx, pdf_dict_get(ctx, obj, PDF_NAME_Contents));
 		char *da = pdf_to_str_buf(ctx, pdf_dict_get(ctx, obj, PDF_NAME_DA));
+		fz_colorspace *cs;
 		fz_rect rect = annot->rect;
 		fz_point pos;
 
@@ -2210,7 +2209,6 @@
 		fz_drop_display_list(ctx, dlist);
 		font_info_fin(ctx, &font_rec);
 		fz_drop_text(ctx, text);
-		fz_drop_colorspace(ctx, cs);
 	}
 	fz_catch(ctx)
 	{
@@ -2347,7 +2345,6 @@
 	fz_device *dev = NULL;
 	font_info font_rec;
 	fz_text *text = NULL;
-	fz_colorspace *cs = NULL;
 	fz_path *path = NULL;
 	fz_buffer *fzbuf = NULL;
 
@@ -2360,7 +2357,6 @@
 	fz_var(dlist);
 	fz_var(dev);
 	fz_var(text);
-	fz_var(cs);
 	fz_var(fzbuf);
 	fz_try(ctx)
 	{
@@ -2368,6 +2364,7 @@
 		fz_rect rect = annot->rect;
 		fz_rect logo_bounds;
 		fz_matrix logo_tm;
+		fz_colorspace *cs = fz_device_rgb(ctx); /* Borrowed reference */
 		unsigned char *bufstr;
 
 		dlist = fz_new_display_list(ctx);
@@ -2378,7 +2375,6 @@
 		fz_bound_path(ctx, path, NULL, &fz_identity, &logo_bounds);
 		center_rect_within_rect(&logo_bounds, &rect, &logo_tm);
 		fz_concat(&logo_tm, &logo_tm, page_ctm);
-		cs = fz_device_rgb(ctx);
 		fz_fill_path(ctx, dev, path, 0, &logo_tm, cs, logo_color, 1.0f);
 		fz_drop_colorspace(ctx, cs);
 		cs = NULL;
@@ -2429,7 +2425,6 @@
 		font_info_fin(ctx, &font_rec);
 		fz_drop_path(ctx, path);
 		fz_drop_text(ctx, text);
-		fz_drop_colorspace(ctx, cs);
 		fz_drop_buffer(ctx, fzbuf);
 	}
 	fz_catch(ctx)
