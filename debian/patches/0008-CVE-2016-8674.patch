From: Kan-Ru Chen <koster@debian.org>
Date: Fri, 17 Feb 2017 09:40:08 +0800
Subject: Port fixes for CVE-2016-8674 from upstream

---
 include/mupdf/pdf/document.h |  4 ++++
 include/mupdf/pdf/object.h   |  1 +
 source/pdf/pdf-object.c      | 43 ++++++++++++++++++++++++++++++++++++++++---
 source/pdf/pdf-repair.c      | 28 ++++++++++++++++++++++++++--
 source/pdf/pdf-xref.c        |  6 ++++++
 5 files changed, 77 insertions(+), 5 deletions(-)

diff --git a/include/mupdf/pdf/document.h b/include/mupdf/pdf/document.h
index 0edfff7..8801004 100644
--- a/include/mupdf/pdf/document.h
+++ b/include/mupdf/pdf/document.h
@@ -286,6 +286,10 @@ struct pdf_document_s
 	int num_type3_fonts;
 	int max_type3_fonts;
 	fz_font **type3_fonts;
+
+	int orphans_max;
+	int orphans_count;
+	pdf_obj **orphans;
 };
 
 /*
diff --git a/include/mupdf/pdf/object.h b/include/mupdf/pdf/object.h
index c841722..3e01892 100644
--- a/include/mupdf/pdf/object.h
+++ b/include/mupdf/pdf/object.h
@@ -92,6 +92,7 @@ pdf_obj *pdf_dict_getsa(pdf_obj *dict, const char *key, const char *abbrev);
 void pdf_dict_put(pdf_obj *dict, pdf_obj *key, pdf_obj *val);
 void pdf_dict_puts(pdf_obj *dict, const char *key, pdf_obj *val);
 void pdf_dict_puts_drop(pdf_obj *dict, const char *key, pdf_obj *val);
+void pdf_dict_get_puts_drop(pdf_obj *dict, const char *key, pdf_obj *val, pdf_obj **old_val);
 void pdf_dict_putp(pdf_obj *dict, const char *key, pdf_obj *val);
 void pdf_dict_putp_drop(pdf_obj *dict, const char *key, pdf_obj *val);
 void pdf_dict_del(pdf_obj *dict, pdf_obj *key);
diff --git a/source/pdf/pdf-object.c b/source/pdf/pdf-object.c
index 51272de..7853f74 100644
--- a/source/pdf/pdf-object.c
+++ b/source/pdf/pdf-object.c
@@ -1005,9 +1005,12 @@ pdf_dict_getsa(pdf_obj *obj, const char *key, const char *abbrev)
 	return pdf_dict_gets(obj, abbrev);
 }
 
-void
-pdf_dict_put(pdf_obj *obj, pdf_obj *key, pdf_obj *val)
+static void
+pdf_dict_get_put(pdf_obj *obj, pdf_obj *key, pdf_obj *val, pdf_obj **old_val)
 {
+	if (old_val)
+		*old_val = NULL;
+
 	int location;
 	char *s;
 	int i;
@@ -1046,7 +1049,10 @@ pdf_dict_put(pdf_obj *obj, pdf_obj *key, pdf_obj *val)
 		{
 			pdf_obj *d = obj->u.d.items[i].v;
 			obj->u.d.items[i].v = pdf_keep_obj(val);
-			pdf_drop_obj(d);
+			if (old_val)
+				*old_val = d;
+			else
+				pdf_drop_obj(d);
 		}
 	}
 	else
@@ -1069,6 +1075,12 @@ pdf_dict_put(pdf_obj *obj, pdf_obj *key, pdf_obj *val)
 }
 
 void
+pdf_dict_put(pdf_obj *obj, pdf_obj *key, pdf_obj *val)
+{
+	pdf_dict_get_put(obj, key, val, NULL);
+}
+
+void
 pdf_dict_puts(pdf_obj *obj, const char *key, pdf_obj *val)
 {
 	pdf_document *doc = obj->doc;
@@ -1115,6 +1127,31 @@ pdf_dict_puts_drop(pdf_obj *obj, const char *key, pdf_obj *val)
 }
 
 void
+pdf_dict_get_puts_drop(pdf_obj *obj, const char *key, pdf_obj *val, pdf_obj **old_val)
+{
+	pdf_document *doc = obj->doc;
+	fz_context *ctx = doc->ctx;
+	pdf_obj *keyobj = NULL;
+
+	fz_var(keyobj);
+
+	fz_try(ctx)
+	{
+		keyobj = pdf_new_name(doc, key);
+		pdf_dict_get_put(obj, keyobj, val, old_val);
+	}
+	fz_always(ctx)
+	{
+		pdf_drop_obj(keyobj);
+		pdf_drop_obj(val);
+	}
+	fz_catch(ctx)
+	{
+		fz_rethrow(ctx);
+	}
+}
+
+void
 pdf_dict_putp(pdf_obj *obj, const char *keys, pdf_obj *val)
 {
 	fz_context *ctx = obj->doc->ctx;
diff --git a/source/pdf/pdf-repair.c b/source/pdf/pdf-repair.c
index e7449de..b1e7e56 100644
--- a/source/pdf/pdf-repair.c
+++ b/source/pdf/pdf-repair.c
@@ -234,6 +234,27 @@ pdf_repair_obj_stm(pdf_document *doc, int num, int gen)
 	}
 }
 
+static void
+orphan_object(fz_context *ctx, pdf_document *doc, pdf_obj *obj)
+{
+	if (doc->orphans_count == doc->orphans_max)
+	{
+		int new_max = (doc->orphans_max ? doc->orphans_max*2 : 32);
+
+		fz_try(ctx)
+		{
+			doc->orphans = fz_resize_array(ctx, doc->orphans, new_max, sizeof(*doc->orphans));
+			doc->orphans_max = new_max;
+		}
+		fz_catch(ctx)
+		{
+			pdf_drop_obj(obj);
+			fz_rethrow(ctx);
+		}
+	}
+	doc->orphans[doc->orphans_count++] = obj;
+}
+
 void
 pdf_repair_xref(pdf_document *doc, pdf_lexbuf *buf)
 {
@@ -469,11 +490,14 @@ pdf_repair_xref(pdf_document *doc, pdf_lexbuf *buf)
 			/* correct stream length for unencrypted documents */
 			if (!encrypt && list[i].stm_len >= 0)
 			{
+				pdf_obj *old_obj = NULL;
 				dict = pdf_load_object(doc, list[i].num, list[i].gen);
 
 				length = pdf_new_int(doc, list[i].stm_len);
-				pdf_dict_puts(dict, "Length", length);
-				pdf_drop_obj(length);
+				pdf_dict_get_puts_drop(dict, "Length", length, &old_obj);
+
+				if (old_obj)
+					orphan_object(ctx, doc, old_obj);
 
 				pdf_drop_obj(dict);
 			}
diff --git a/source/pdf/pdf-xref.c b/source/pdf/pdf-xref.c
index c01bc61..fbc1bed 100644
--- a/source/pdf/pdf-xref.c
+++ b/source/pdf/pdf-xref.c
@@ -1271,6 +1271,12 @@ pdf_close_document(pdf_document *doc)
 
 	pdf_lexbuf_fin(&doc->lexbuf.base);
 
+	for (i = 0; i < doc->orphans_count; i++)
+	{
+		pdf_drop_obj(doc->orphans[i]);
+	}
+	fz_free(ctx, doc->orphans);
+
 	fz_free(ctx, doc);
 }
 
