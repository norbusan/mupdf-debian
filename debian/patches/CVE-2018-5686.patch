From: Kan-Ru Chen <kanru@kanru.info>
Date: Sun, 28 Oct 2018 17:26:10 +0900
Subject: CVE-2018-5686

X-Git-Url: https://git.ghostscript.com/?p=mupdf.git;a=blobdiff_plain;f=include/mupdf/fitz/stream.h;h=790a0a83d3850facdceefb3c3e598fdb63d4e14d;hp=cd26be9039c064c8028fd6ca958044d133644e29;hb=b70eb93f6936c03d8af52040bbca4d4a7db39079;hpb=0d7359fbcd331ec0a22ec163dacff953f9817814
---
 include/mupdf/fitz/stream.h | 29 ++++++++++++++++++++++-------
 1 file changed, 22 insertions(+), 7 deletions(-)

diff --git a/include/mupdf/fitz/stream.h b/include/mupdf/fitz/stream.h
index 233e2b0..6a40b97 100644
--- a/include/mupdf/fitz/stream.h
+++ b/include/mupdf/fitz/stream.h
@@ -265,10 +265,11 @@ static inline size_t fz_available(fz_context *ctx, fz_stream *stm, int max)
 
 	if (len)
 		return len;
+	if (stm->eof)
+		return 0;
+
 	fz_try(ctx)
-	{
 		c = stm->next(ctx, stm, max);
-	}
 	fz_catch(ctx)
 	{
 		fz_rethrow_if(ctx, FZ_ERROR_TRYLATER);
@@ -291,10 +292,10 @@ static inline int fz_read_byte(fz_context *ctx, fz_stream *stm)
 
 	if (stm->rp != stm->wp)
 		return *stm->rp++;
+	if (stm->eof)
+		return EOF;
 	fz_try(ctx)
-	{
 		c = stm->next(ctx, stm, 1);
-	}
 	fz_catch(ctx)
 	{
 		fz_rethrow_if(ctx, FZ_ERROR_TRYLATER);
@@ -313,10 +314,24 @@ static inline int fz_peek_byte(fz_context *ctx, fz_stream *stm)
 
 	if (stm->rp != stm->wp)
 		return *stm->rp;
+	if (stm->eof)
+		return EOF;
 
-	c = stm->next(ctx, stm, 1);
-	if (c != EOF)
-		stm->rp--;
+	fz_try(ctx)
+	{
+		c = stm->next(ctx, stm, 1);
+		if (c != EOF)
+			stm->rp--;
+	}
+	fz_catch(ctx)
+	{
+		fz_rethrow_if(ctx, FZ_ERROR_TRYLATER);
+		fz_warn(ctx, "read error; treating as end of file");
+		stm->error = 1;
+		c = EOF;
+	}
+	if (c == EOF)
+		stm->eof = 1;
 	return c;
 }
 
