From: Kan-Ru Chen <kanru@kanru.info>
Date: Sun, 28 Oct 2018 17:22:44 +0900
Subject: CVE-2018-1000040

X-Git-Url: https://git.ghostscript.com/?p=mupdf.git;a=patch;h=83d4dae44c71816c084a635550acc1a51529b881;hp=f597300439e62f5e921f0d7b1e880b5c1a1f1607
---
 source/fitz/colorspace.c | 19 ++++++++++---------
 1 file changed, 10 insertions(+), 9 deletions(-)

diff --git a/source/fitz/colorspace.c b/source/fitz/colorspace.c
index d24aad5..951eca6 100644
--- a/source/fitz/colorspace.c
+++ b/source/fitz/colorspace.c
@@ -432,13 +432,13 @@ fast_cmyk_to_rgb_ARM(unsigned char *dst, unsigned char *src, int n)
 	"b	2f			@ enter loop			\n"
 	"1:				@ White or Black		\n"
 	"@ Cunning trick: On entry r11 = 0 if black, r11 = FF if white	\n"
-	"eor    r12,r11,#0xFF           @ r12= FF if black, 0 if white  \n"
+	"eor	r12,r11,#0xFF		@ r12= FF if black, 0 if white	\n"
 	"ldrb	r7, [r1],#1		@ r8 = s[4]			\n"
 	"strb	r11,[r0],#1		@ d[0] = r			\n"
 	"strb	r11,[r0],#1		@ d[1] = g			\n"
 	"strb	r11,[r0],#1		@ d[2] = b			\n"
 	"strb	r7, [r0],#1		@ d[3] = s[4]			\n"
-	"mov    r12,r12,LSL #24         @ r12 = CMYK                    \n"
+	"mov	r12,r12,LSL #24		@ r12 = CMYK			\n"
 	"subs	r2, r2, #1		@ r2 = n--			\n"
 	"beq	9f							\n"
 	"2:				@ Main loop starts here		\n"
@@ -495,9 +495,9 @@ fast_cmyk_to_rgb_ARM(unsigned char *dst, unsigned char *src, int n)
 	"rsb	r7, r14,r7, LSL #8	@ r7 = x0 = (c1m1y<<8) - x1	\n"
 	"add	r0, r0, r7		@ r0 = r += x0			\n"
 	"add	r1, r1, r7		@ r1 = g += (x0>>8 * 256)	\n"
-	"sub	r1, r1, r7, LSR #8-3	@                    248	\n"
-	"sub	r1, r1, r7, LSR #8-2	@                    244	\n"
-	"sub	r1, r1, r7, LSR #8	@                    243	\n"
+	"sub	r1, r1, r7, LSR #8-3	@		     248	\n"
+	"sub	r1, r1, r7, LSR #8-2	@		     244	\n"
+	"sub	r1, r1, r7, LSR #8	@		     243	\n"
 	"sub	r7, r14,r14,LSR #3	@ r7 = 28*(x1>>5)		\n"
 	"add	r0, r0, r7, LSR #8-5	@ r0 = r += 28 * x1		\n"
 	"sub	r7, r7, r14,LSR #4	@ r7 = 26*(x1>>5)		\n"
@@ -526,9 +526,9 @@ fast_cmyk_to_rgb_ARM(unsigned char *dst, unsigned char *src, int n)
 	"mul	r14,r3, r6		@ r14= x1 = cm1y1 * k		\n"
 	"sub	r3, r3, r14,LSR #8	@ r3 = x1>>8 = cm1y1 - (x1>>8)	\n"
 	"add	r1, r1, r14,LSR #8-4	@ r1 = g += 16*x1		\n"
-	"sub	r1, r1, r14,LSR #8	@           15*x1		\n"
+	"sub	r1, r1, r14,LSR #8	@	    15*x1		\n"
 	"add	r4, r4, r14,LSR #8-5	@ r4 = b += 32*x1		\n"
-	"add	r4, r4, r14,LSR #8-2	@           36*x1		\n"
+	"add	r4, r4, r14,LSR #8-2	@	    36*x1		\n"
 	"mov	r14,#174		@ r14= 174			\n"
 	"mla	r1, r14,r3, r1		@ r1 = g += 174 * x0		\n"
 	"mov	r14,#240		@ r14= 240			\n"
@@ -537,8 +537,8 @@ fast_cmyk_to_rgb_ARM(unsigned char *dst, unsigned char *src, int n)
 	"mul	r14,r11,r6		@ r14= x1 = cm1y * k		\n"
 	"sub	r11,r11,r14,LSR #8	@ r11= x0>>8 = cm1y - (x1>>8)	\n"
 	"add	r1, r1, r14,LSR #8-4	@ r1 = g += x1 * 16		\n"
-	"add	r1, r1, r14,LSR #8	@           x1 * 17		\n"
-	"add	r1, r1, r14,LSR #8-1	@           x1 * 19		\n"
+	"add	r1, r1, r14,LSR #8	@	    x1 * 17		\n"
+	"add	r1, r1, r14,LSR #8-1	@	    x1 * 19		\n"
 	"mov	r14,#167		@ r14 = 167			\n"
 	"mla	r1, r14,r11,r1		@ r1 = g += 167 * x0		\n"
 	"mov	r14,#80			@ r14 = 80			\n"
@@ -1335,6 +1335,7 @@ void fz_init_cached_color_converter(fz_context *ctx, fz_color_converter *cc, fz_
 	fz_catch(ctx)
 	{
 		fz_drop_hash(ctx, cached->hash);
+		cc->opaque = NULL;
 		fz_rethrow(ctx);
 	}
 }
